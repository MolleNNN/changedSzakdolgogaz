<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Positions</title>
    	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<script th:src="@{/js/scripts.js}"></script>
	<link rel="stylesheet" th:href="@{/css/styles.css}" />
	
</head>
<body>
 <!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light navbar-custom">
    <a class="navbar-brand" th:href="@{/admin}">Kezdőlap</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/data}">Adatok</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/ppt}">Oktatás</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/positions}">Pozíciók</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/companies}">Cégek</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/receivers}">Fogadó felek</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/dataupload}">Adat feltöltés</a>
            </li>
            <!-- New Fields -->
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/datas}">Datas</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/results}">Results</a>
            </li>
        </ul>
    </div>
</nav>

<div class="container mt-5">
    <div id="notification-container"></div>

    <h2>Positions</h2>
    <table id="positionsTable" class="display">
        <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="position : ${positions}">
            <td th:text="${position.id}">1</td>
            <td th:text="${position.name}">Position Name</td>
        </tr>
        </tbody>
    </table>

    <h2>Add New Position</h2>
    <form id="addPositionForm" th:action="@{/admin/positions}" th:object="${newPosition}" method="post" class="form-inline">
        <div class="form-group mr-2">
            <label for="name" class="mr-2">Position Name:</label>
            <input type="text" id="name" name="name" th:value="*{name}" required minlength="2" maxlength="255" class="form-control" />
        </div>
        <button type="submit" class="btn btn-success">Add Position</button>
    </form>

    <h2>Modify Position</h2>
    <button id="showModifyPosition" class="btn btn-primary mb-2">Modify Position</button>
    <div id="modifyPositionContainer" style="display: none;">
        <form id="modifyPositionForm" th:action="@{/admin/updatePosition}" method="post">
            <div class="form-group">
                <label for="modifyPositionSelect">Select Position:</label>
                <select id="modifyPositionSelect" name="positionId" class="form-control" required>
                    <option value="" disabled selected>Select a position</option>
                </select>
            </div>
            <div class="form-group" id="newPositionGroup" style="display: none;">
                <label for="newPositionName">New Position Name:</label>
                <input type="text" id="newPositionName" name="name" class="form-control" required minlength="2" maxlength="255" />
            </div>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" id="savePositionButton" class="btn btn-success" style="display: none;">Save</button>
            <button type="button" id="cancelModifyButton" class="btn btn-secondary" style="display: none;">Cancel</button>
        </form>
    </div>

    <h2>Delete Position</h2>
    <button id="showDeletablePositions" class="btn btn-danger mb-2">Show Deletable Positions</button>
    <form id="deletePositionForm" th:action="@{/admin/deletePosition}" method="post">
        <div id="deletablePositionContainer" style="display: none;">
            <div class="form-group">
                <select id="deletablePositionSelect" name="positionId" class="form-control" required>
                    <option value="" disabled selected>Select a position</option>
                </select>
            </div>
            <button type="submit" id="deletePositionButton" class="btn btn-danger" style="display: none;">Delete</button>
            <button type="button" id="cancelDeleteButton" class="btn btn-secondary" style="display: none;">Cancel</button>
        </div>
        <input type="hidden" name="_csrf" value="${_csrf.token}">
    </form>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- DataTables JS -->
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
$(document).ready(function () {
    // Initialize DataTables
    var table = $('#positionsTable').DataTable({
        ajax: {
            url: '/admin/getAllPositions',
            dataSrc: ''
        },
        columns: [
            { data: 'id' },
            { data: 'name' }
        ]
    });

    // Function to create notification div
    function createNotification(message, type) {
        var notificationHtml = `
            <div id="notification" class="alert alert-dismissible alert-${type} fade show">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <span id="notification-message">${message}</span>
            </div>
        `;
        $('#notification-container').html(notificationHtml);
        console.log('Notification should be shown now.');
    }

    // Handle form submission for adding positions
    $('#addPositionForm').submit(function(event) {
        event.preventDefault(); // Stop the form from causing a page reload
        var formData = $(this).serialize();
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            success: function(response) {
                console.log('Add position response:', response);
                if (response.success) {
                    createNotification(response.message, 'success');
                    // Refresh positions table
                    table.ajax.reload();
                    // Clear the input field
                    $('#name').val('');
                } else {
                    createNotification(response.message, 'danger');
                }
            },
            error: function(xhr) {
                console.log('Error adding position:', xhr.statusText);
                createNotification('Error adding position: ' + xhr.statusText, 'danger');
            }
        });
    });

    // Show modify positions
    $('#showModifyPosition').click(function() {
        $.getJSON('/admin/getAllPositions', function(data) {
            var select = $('#modifyPositionSelect');
            select.empty();
            select.append($('<option>', {
                value: '',
                disabled: true,
                selected: true,
                text: 'Select a position'
            }));
            $.each(data, function(index, position) {
                select.append($('<option>', { value: position.id, text: position.name }));
            });
            $('#modifyPositionContainer').show();
        }).fail(function() {
            alert('Error fetching positions');
        });
    });

    // Handle form submission for modifying positions
    $('#modifyPositionForm').submit(function(event) {
        event.preventDefault(); // Stop the form from causing a page reload
        var formData = $(this).serialize();
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            success: function(response) {
                console.log('Modify position response:', response);
                if (response.success) {
                    createNotification(response.message, 'success');
                    // Reset and hide form fields
                    $('#modifyPositionContainer').hide();
                    $('#newPositionGroup').hide();
                    $('#savePositionButton').hide();
                    $('#cancelModifyButton').hide();
                    $('#modifyPositionSelect').val('');
                    $('#newPositionName').val(''); // Clear the input field
                    // Refresh positions table
                    table.ajax.reload();
                } else {
                    createNotification(response.error, 'danger');
                }
            },
            error: function(xhr) {
                console.log('Error modifying position:', xhr.statusText);
                createNotification('Error modifying position: ' + xhr.statusText, 'danger');
            }
        });
    });

    // Show new position name input and populate it when a position is selected
    $('#modifyPositionSelect').change(function() {
        var selectedPositionId = $(this).val();
        var selectedPositionName = $(this).find("option:selected").text();
        console.log("Position selected:", selectedPositionId, selectedPositionName); // Debug log
        if (selectedPositionId) {
            $('#newPositionName').val(selectedPositionName); // Set the selected name in the input
            $('#newPositionGroup').show();
            $('#savePositionButton').show();
            $('#cancelModifyButton').show();
        } else {
            $('#newPositionGroup').hide();
            $('#savePositionButton').hide();
            $('#cancelModifyButton').hide();
            $('#newPositionName').val(''); // Clear the input field
        }
    });

    // Cancel modify
    $('#cancelModifyButton').click(function() {
        $('#modifyPositionContainer').hide();
        $('#newPositionGroup').hide();
        $('#savePositionButton').hide();
        $('#cancelModifyButton').hide();
        $('#modifyPositionSelect').val('');
        $('#newPositionName').val(''); // Clear the input field
    });

    // Show deletable positions
    $('#showDeletablePositions').click(function() {
        $.getJSON('/admin/getDeletablePositions', function(data) {
            var select = $('#deletablePositionSelect');
            select.empty();
            select.append($('<option>', { value: '', disabled: true, selected: true, text: 'Select a position' }));
            if (data.length > 0) {
                $.each(data, function(index, position) {
                    select.append($('<option>', { value: position.id, text: position.name }));
                });
                $('#deletablePositionContainer').show(); // Show container
            } else {
                alert('No deletable positions found');
                $('#deletablePositionContainer').hide();
            }
        }).fail(function() {
            console.error('Error fetching deletable positions');
            alert('Error fetching deletable positions');
        });
    });

    // Listen for changes on the select dropdown
    $('#deletablePositionSelect').change(function() {
        var selected = $(this).val();
        console.log("Selection changed, selected value:", selected); // Debug output
        if (selected) {
            $('#deletePositionButton').show();
            $('#cancelDeleteButton').show();
        } else {
            $('#deletePositionButton').hide();
            $('#cancelDeleteButton').hide();
        }
    });

    // Handle form submission for deletion via AJAX
    $('#deletePositionForm').submit(function(event) {
        event.preventDefault();
        var selectedPositionId = $('#deletablePositionSelect').val();
        $.ajax({
            url: '/admin/deletePosition/' + selectedPositionId,
            type: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                console.log('Delete position response:', response);
                if(response.success) {
                    createNotification(response.message, 'success');
                    // Hide the select options and buttons
                    $('#deletablePositionContainer').hide();
                    $('#deletePositionButton').hide();
                    $('#cancelDeleteButton').hide();
                    $('#deletablePositionSelect').val('');
                    // Refresh positions table
                    table.ajax.reload();
                } else {
                    createNotification(response.message, 'danger');
                }
            },
            error: function(xhr) {
                console.log('Error deleting position:', xhr.statusText);
                createNotification('Error deleting position: ' + xhr.statusText, 'danger');
            }
        });
    });

    // Cancel delete
    $('#cancelDeleteButton').click(function() {
        $('#deletablePositionContainer').hide();
        $('#deletePositionButton').hide();
        $('#cancelDeleteButton').hide();
        $('#deletablePositionSelect').val('');
    });
});
</script>

</body>
</html>
