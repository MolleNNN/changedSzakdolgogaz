<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Companies</title>
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" th:href="@{/css/styles.css}" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:src="@{/js/scripts.js}"></script>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light navbar-custom">
    <a class="navbar-brand" th:href="@{/admin}">Kezdőlap</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/data}">Adatok</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/ppt}">Oktatás</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/positions}">Pozíciók</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/companies}">Cégek</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/receivers}">Fogadó felek</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/dataupload}">Adat feltöltés</a>
            </li>
            <!-- New Fields -->
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/datas}">Datas</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/results}">Results</a>
            </li>
        </ul>
    </div>
</nav>

<div class="container mt-5">
    <div id="notification-container"></div>

    <h2>Companies</h2>
    <table id="companiesTable" class="display">
        <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="company : ${companies}">
            <td th:text="${company.id}">1</td>
            <td th:text="${company.name}">Company Name</td>
        </tr>
        </tbody>
    </table>

    <h2>Add New Company</h2>
    <form id="addCompanyForm" th:action="@{/admin/companies}" th:object="${newCompany}" method="post" class="form-inline">
        <div class="form-group mr-2">
            <label for="name" class="mr-2">Company Name:</label>
            <input type="text" id="name" name="name" th:value="*{name}" required minlength="2" maxlength="255" class="form-control" />
        </div>
        <button type="submit" class="btn btn-success">Add Company</button>
    </form>

    <h2>Modify Company</h2>
    <button id="showModifyCompany" class="btn btn-primary mb-2">Modify Company</button>
    <div id="modifyCompanyContainer" style="display: none;">
        <form id="modifyCompanyForm" th:action="@{/admin/updateCompany}" method="post">
            <div class="form-group">
                <label for="modifyCompanySelect">Select Company:</label>
                <select id="modifyCompanySelect" name="companyId" class="form-control" required>
                    <option value="" disabled selected>Select a company</option>
                </select>
            </div>
            <div class="form-group" id="newCompanyGroup" style="display: none;">
                <label for="newCompanyName">New Company Name:</label>
                <input type="text" id="newCompanyName" name="name" class="form-control" required minlength="2" maxlength="255" />
            </div>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" id="saveCompanyButton" class="btn btn-success" style="display: none;">Save</button>
            <button type="button" id="cancelModifyButton" class="btn btn-secondary" style="display: none;">Cancel</button>
        </form>
    </div>

    <h2>Delete Company</h2>
    <button id="showDeletableCompanies" class="btn btn-danger mb-2">Show Deletable Companies</button>
    <form id="deleteCompanyForm" th:action="@{/admin/deleteCompany}" method="post">
        <div id="deletableCompanyContainer" style="display: none;">
            <div class="form-group">
                <select id="deletableCompanySelect" name="companyId" class="form-control" required>
                    <option value="" disabled selected>Select a company</option>
                </select>
            </div>
            <button type="submit" id="deleteCompanyButton" class="btn btn-danger" style="display: none;">Delete</button>
            <button type="button" id="cancelDeleteButton" class="btn btn-secondary" style="display: none;">Cancel</button>
        </div>
        <input type="hidden" name="_csrf" value="${_csrf.token}">
    </form>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- DataTables JS -->
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
$(document).ready(function () {
    // Initialize DataTables
    var table = $('#companiesTable').DataTable({
        ajax: {
            url: '/admin/getAllCompanies',
            dataSrc: ''
        },
        columns: [
            { data: 'id' },
            { data: 'name' }
        ]
    });

    // Function to create notification div
    function createNotification(message, type) {
        var notificationHtml = `
            <div id="notification" class="alert alert-dismissible alert-${type} fade show">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <span id="notification-message">${message}</span>
            </div>
        `;
        $('#notification-container').html(notificationHtml);
        console.log('Notification should be shown now.');
    }

    // Handle form submission for adding companies
    $('#addCompanyForm').submit(function(event) {
        event.preventDefault(); // Stop the form from causing a page reload
        var formData = $(this).serialize();
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            success: function(response) {
                console.log('Add company response:', response);
                if (response.success) {
                    createNotification(response.message, 'success');
                    // Refresh companies table
                    table.ajax.reload();
                    // Clear the input field
                    $('#name').val('');
                } else {
                    createNotification(response.message, 'danger');
                }
            },
            error: function(xhr) {
                console.log('Error adding company:', xhr.statusText);
                createNotification('Error adding company: ' + xhr.statusText, 'danger');
            }
        });
    });

    // Show modify companies
    $('#showModifyCompany').click(function() {
        $.getJSON('/admin/getAllCompanies', function(data) {
            var select = $('#modifyCompanySelect');
            select.empty();
            select.append($('<option>', {
                value: '',
                disabled: true,
                selected: true,
                text: 'Select a company'
            }));
            $.each(data, function(index, company) {
                select.append($('<option>', { value: company.id, text: company.name }));
            });
            $('#modifyCompanyContainer').show();
        }).fail(function() {
            alert('Error fetching companies');
        });
    });

    // Handle form submission for modifying companies
    $('#modifyCompanyForm').submit(function(event) {
        event.preventDefault(); // Stop the form from causing a page reload
        var formData = $(this).serialize();
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            success: function(response) {
                console.log('Modify company response:', response);
                if (response.success) {
                    createNotification(response.message, 'success');
                    // Reset and hide form fields
                    $('#modifyCompanyContainer').hide();
                    $('#newCompanyGroup').hide();
                    $('#saveCompanyButton').hide();
                    $('#cancelModifyButton').hide();
                    $('#modifyCompanySelect').val('');
                    $('#newCompanyName').val(''); // Clear the input field
                    // Refresh companies table
                    table.ajax.reload();
                } else {
                    createNotification(response.error, 'danger');
                }
            },
            error: function(xhr) {
                console.log('Error modifying company:', xhr.statusText);
                createNotification('Error modifying company: ' + xhr.statusText, 'danger');
            }
        });
    });

    // Show new company name input and populate it when a company is selected
    $('#modifyCompanySelect').change(function() {
        var selectedCompanyId = $(this).val();
        var selectedCompanyName = $(this).find("option:selected").text();
        console.log("Company selected:", selectedCompanyId, selectedCompanyName); // Debug log
        if (selectedCompanyId) {
            $('#newCompanyName').val(selectedCompanyName); // Set the selected name in the input
            $('#newCompanyGroup').show();
            $('#saveCompanyButton').show();
            $('#cancelModifyButton').show();
        } else {
            $('#newCompanyGroup').hide();
            $('#saveCompanyButton').hide();
            $('#cancelModifyButton').hide();
            $('#newCompanyName').val(''); // Clear the input field
        }
    });

    // Cancel modify
    $('#cancelModifyButton').click(function() {
        $('#modifyCompanyContainer').hide();
        $('#newCompanyGroup').hide();
        $('#saveCompanyButton').hide();
        $('#cancelModifyButton').hide();
        $('#modifyCompanySelect').val('');
        $('#newCompanyName').val(''); // Clear the input field
    });

    // Show deletable companies
    $('#showDeletableCompanies').click(function() {
        $.getJSON('/admin/getDeletableCompanies', function(data) {
            var select = $('#deletableCompanySelect');
            select.empty();
            select.append($('<option>', { value: '', disabled: true, selected: true, text: 'Select a company' }));
            if (data.length > 0) {
                $.each(data, function(index, company) {
                    select.append($('<option>', { value: company.id, text: company.name }));
                });
                $('#deletableCompanyContainer').show(); // Show container
            } else {
                alert('No deletable companies found');
                $('#deletableCompanyContainer').hide();
            }
        }).fail(function() {
            console.error('Error fetching deletable companies');
            alert('Error fetching deletable companies');
        });
    });

    // Listen for changes on the select dropdown
    $('#deletableCompanySelect').change(function() {
        var selected = $(this).val();
        console.log("Selection changed, selected value:", selected); // Debug output
        if (selected) {
            $('#deleteCompanyButton').show();
            $('#cancelDeleteButton').show();
        } else {
            $('#deleteCompanyButton').hide();
            $('#cancelDeleteButton').hide();
        }
    });

    // Handle form submission for deletion via AJAX
    $('#deleteCompanyForm').submit(function(event) {
        event.preventDefault();
        var selectedCompanyId = $('#deletableCompanySelect').val();
        $.ajax({
            url: '/admin/deleteCompany/' + selectedCompanyId,
            type: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                console.log('Delete company response:', response);
                if(response.success) {
                    createNotification(response.message, 'success');
                    // Hide the select options and buttons
                    $('#deletableCompanyContainer').hide();
                    $('#deleteCompanyButton').hide();
                    $('#cancelDeleteButton').hide();
                    $('#deletableCompanySelect').val('');
                    // Refresh companies table
                    table.ajax.reload();
                } else {
                    createNotification(response.message, 'danger');
                }
            },
            error: function(xhr) {
                console.log('Error deleting company:', xhr.statusText);
                createNotification('Error deleting company: ' + xhr.statusText, 'danger');
            }
        });
    });

    // Cancel delete
    $('#cancelDeleteButton').click(function() {
        $('#deletableCompanyContainer').hide();
        $('#deleteCompanyButton').hide();
        $('#cancelDeleteButton').hide();
        $('#deletableCompanySelect').val('');
    });
});
</script>

</body>
</html>
