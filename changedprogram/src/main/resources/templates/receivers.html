<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Receivers</title>
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" th:href="@{/css/styles.css}" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:src="@{/js/scripts.js}"></script>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light navbar-custom">
    <a class="navbar-brand" th:href="@{/admin}">Kezdőlap</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/data}">Adatok</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/ppt}">Oktatás</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/positions}">Pozíciók</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/companies}">Cégek</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/receivers}">Fogadó felek</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/dataupload}">Adat feltöltés</a>
            </li>
            <!-- New Fields -->
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/datas}">Datas</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/results}">Results</a>
            </li>
        </ul>
    </div>
</nav>

<div class="container mt-5">
    <div id="notification-container"></div>

    <h2>Receivers</h2>
    <table id="receiversTable" class="display">
        <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="receiver : ${receivers}">
            <td th:text="${receiver.id}">1</td>
            <td th:text="${receiver.name}">Receiver Name</td>
        </tr>
        </tbody>
    </table>

    <h2>Add New Receiver</h2>
    <form id="addReceiverForm" th:action="@{/admin/receivers}" th:object="${newReceiver}" method="post" class="form-inline">
        <div class="form-group mr-2">
            <label for="name" class="mr-2">Receiver Name:</label>
            <input type="text" id="name" name="name" th:value="*{name}" required minlength="2" maxlength="255" class="form-control" />
        </div>
        <button type="submit" class="btn btn-success">Add Receiver</button>
    </form>

    <h2>Modify Receiver</h2>
    <button id="showModifyReceiver" class="btn btn-primary mb-2">Modify Receiver</button>
    <div id="modifyReceiverContainer" style="display: none;">
        <form id="modifyReceiverForm" th:action="@{/admin/updateReceiver}" method="post">
            <div class="form-group">
                <label for="modifyReceiverSelect">Select Receiver:</label>
                <select id="modifyReceiverSelect" name="receiverId" class="form-control" required>
                    <option value="" disabled selected>Select a receiver</option>
                </select>
            </div>
            <div class="form-group" id="newReceiverGroup" style="display: none;">
                <label for="newReceiverName">New Receiver Name:</label>
                <input type="text" id="newReceiverName" name="name" class="form-control" required minlength="2" maxlength="255" />
            </div>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" id="saveReceiverButton" class="btn btn-success" style="display: none;">Save</button>
            <button type="button" id="cancelModifyButton" class="btn btn-secondary" style="display: none;">Cancel</button>
        </form>
    </div>

    <h2>Delete Receiver</h2>
    <button id="showDeletableReceivers" class="btn btn-danger mb-2">Show Deletable Receivers</button>
    <form id="deleteReceiverForm" th:action="@{/admin/deleteReceiver}" method="post">
        <div id="deletableReceiverContainer" style="display: none;">
            <div class="form-group">
                <select id="deletableReceiverSelect" name="receiverId" class="form-control" required>
                    <option value="" disabled selected>Select a receiver</option>
                </select>
            </div>
            <button type="submit" id="deleteReceiverButton" class="btn btn-danger" style="display: none;">Delete</button>
            <button type="button" id="cancelDeleteButton" class="btn btn-secondary" style="display: none;">Cancel</button>
        </div>
        <input type="hidden" name="_csrf" value="${_csrf.token}">
    </form>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- DataTables JS -->
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
$(document).ready(function () {
    // Initialize DataTables
    var table = $('#receiversTable').DataTable({
        ajax: {
            url: '/admin/getAllReceivers',
            dataSrc: ''
        },
        columns: [
            { data: 'id' },
            { data: 'name' }
        ]
    });

    // Function to create notification div
    function createNotification(message, type) {
        var notificationHtml = `
            <div id="notification" class="alert alert-dismissible alert-${type} fade show">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <span id="notification-message">${message}</span>
            </div>
        `;
        $('#notification-container').html(notificationHtml);
        console.log('Notification should be shown now.');
    }

    // Handle form submission for adding receivers
    $('#addReceiverForm').submit(function(event) {
        event.preventDefault(); // Stop the form from causing a page reload
        var formData = $(this).serialize();
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            success: function(response) {
                console.log('Add receiver response:', response);
                if (response.success) {
                    createNotification(response.message, 'success');
                    // Refresh receivers table
                    table.ajax.reload();
                    // Clear the input field
                    $('#name').val('');
                } else {
                    createNotification(response.message, 'danger');
                }
            },
            error: function(xhr) {
                console.log('Error adding receiver:', xhr.statusText);
                createNotification('Error adding receiver: ' + xhr.statusText, 'danger');
            }
        });
    });

    // Show modify receivers
    $('#showModifyReceiver').click(function() {
        $.getJSON('/admin/getAllReceivers', function(data) {
            var select = $('#modifyReceiverSelect');
            select.empty();
            select.append($('<option>', {
                value: '',
                disabled: true,
                selected: true,
                text: 'Select a receiver'
            }));
            $.each(data, function(index, receiver) {
                select.append($('<option>', { value: receiver.id, text: receiver.name }));
            });
            $('#modifyReceiverContainer').show();
        }).fail(function() {
            alert('Error fetching receivers');
        });
    });

    // Handle form submission for modifying receivers
    $('#modifyReceiverForm').submit(function(event) {
        event.preventDefault(); // Stop the form from causing a page reload
        var formData = $(this).serialize();
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            success: function(response) {
                console.log('Modify receiver response:', response);
                if (response.success) {
                    createNotification(response.message, 'success');
                    // Reset and hide form fields
                    $('#modifyReceiverContainer').hide();
                    $('#newReceiverGroup').hide();
                    $('#saveReceiverButton').hide();
                    $('#cancelModifyButton').hide();
                    $('#modifyReceiverSelect').val('');
                    $('#newReceiverName').val(''); // Clear the input field
                    // Refresh receivers table
                    table.ajax.reload();
                } else {
                    createNotification(response.error, 'danger');
                }
            },
            error: function(xhr) {
                console.log('Error modifying receiver:', xhr.statusText);
                createNotification('Error modifying receiver: ' + xhr.statusText, 'danger');
            }
        });
    });

    // Show new receiver name input and populate it when a receiver is selected
    $('#modifyReceiverSelect').change(function() {
        var selectedReceiverId = $(this).val();
        var selectedReceiverName = $(this).find("option:selected").text();
        console.log("Receiver selected:", selectedReceiverId, selectedReceiverName); // Debug log
        if (selectedReceiverId) {
            $('#newReceiverName').val(selectedReceiverName); // Set the selected name in the input
            $('#newReceiverGroup').show();
            $('#saveReceiverButton').show();
            $('#cancelModifyButton').show();
        } else {
            $('#newReceiverGroup').hide();
            $('#saveReceiverButton').hide();
            $('#cancelModifyButton').hide();
            $('#newReceiverName').val(''); // Clear the input field
        }
    });

    // Cancel modify
    $('#cancelModifyButton').click(function() {
        $('#modifyReceiverContainer').hide();
        $('#newReceiverGroup').hide();
        $('#saveReceiverButton').hide();
        $('#cancelModifyButton').hide();
        $('#modifyReceiverSelect').val('');
        $('#newReceiverName').val(''); // Clear the input field
    });

    // Show deletable receivers
    $('#showDeletableReceivers').click(function() {
        $.getJSON('/admin/getDeletableReceivers', function(data) {
            var select = $('#deletableReceiverSelect');
            select.empty();
            select.append($('<option>', { value: '', disabled: true, selected: true, text: 'Select a receiver' }));
            if (data.length > 0) {
                $.each(data, function(index, receiver) {
                    select.append($('<option>', { value: receiver.id, text: receiver.name }));
                });
                $('#deletableReceiverContainer').show(); // Show container
            } else {
                alert('No deletable receivers found');
                $('#deletableReceiverContainer').hide();
            }
        }).fail(function() {
            console.error('Error fetching deletable receivers');
            alert('Error fetching deletable receivers');
        });
    });

    // Listen for changes on the select dropdown
    $('#deletableReceiverSelect').change(function() {
        var selected = $(this).val();
        console.log("Selection changed, selected value:", selected); // Debug output
        if (selected) {
            $('#deleteReceiverButton').show();
            $('#cancelDeleteButton').show();
        } else {
            $('#deleteReceiverButton').hide();
            $('#cancelDeleteButton').hide();
        }
    });

    // Handle form submission for deletion via AJAX
    $('#deleteReceiverForm').submit(function(event) {
        event.preventDefault();
        var selectedReceiverId = $('#deletableReceiverSelect').val();
        $.ajax({
            url: '/admin/deleteReceiver/' + selectedReceiverId,
            type: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                console.log('Delete receiver response:', response);
                if(response.success) {
                    createNotification(response.message, 'success');
                    // Hide the select options and buttons
                    $('#deletableReceiverContainer').hide();
                    $('#deleteReceiverButton').hide();
                    $('#cancelDeleteButton').hide();
                    $('#deletableReceiverSelect').val('');
                    // Refresh receivers table
                    table.ajax.reload();
                } else {
                    createNotification(response.message, 'danger');
                }
            },
            error: function(xhr) {
                console.log('Error deleting receiver:', xhr.statusText);
                createNotification('Error deleting receiver: ' + xhr.statusText, 'danger');
            }
        });
    });

    // Cancel delete
    $('#cancelDeleteButton').click(function() {
        $('#deletableReceiverContainer').hide();
        $('#deleteReceiverButton').hide();
        $('#cancelDeleteButton').hide();
        $('#deletableReceiverSelect').val('');
    });
});
</script>

</body>
</html>
