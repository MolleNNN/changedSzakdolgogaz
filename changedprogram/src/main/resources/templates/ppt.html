<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" th:content="${_csrf.token}"/>
<meta name="csrf-param" th:content="${_csrf.parameterName}"/>
    
    
    <title>PPT Management</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    	<link rel="stylesheet" th:href="@{/css/styles.css}" />
    	
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script th:src="@{/js/scripts.js}"></script>
    <script>
    function setPptSession(pptId) {
        var csrfToken = $('meta[name="csrf-token"]').attr('content');
        var csrfParam = $('meta[name="csrf-param"]').attr('content');

        var form = $('<form>', {
            method: 'POST',
            action: '/admin/setPptSession'
        });

        // CSRF token input
        form.append($('<input>', {
            type: 'hidden',
            name: csrfParam,
            value: csrfToken
        }));

        // pptId input
        form.append($('<input>', {
            type: 'hidden',
            name: 'pptId',
            value: pptId
        }));

        $('body').append(form);
        form.submit();
    }

        var images = [];
        var currentImageIndex = 0;

        function showPptImagesModal(pptId) {
            $.getJSON('/admin/getPptImages', { pptId: pptId }, function(data) {
                images = data;
                if (images.length > 0) {
                    currentImageIndex = 0;
                    showImage(currentImageIndex);
                    $('#pptModal').modal('show');
                } else {
                    alert('No images found for this PPT.');
                }
            }).fail(function(jqXHR, textStatus, errorThrown) {
                alert('Error fetching images: ' + textStatus + ' ' + errorThrown);
            });
        }

        function showImage(index) {
            currentImageIndex = index;
            var base64Image = images[index];
            if (base64Image) {
                document.getElementById('pptImage').src = 'data:image/png;base64,' + base64Image;
            }
            document.getElementById('previousButton').disabled = index == 0;
            document.getElementById('nextButton').disabled = index == images.length - 1;
        }

        function nextImage() {
            if (currentImageIndex < images.length - 1) {
                showImage(currentImageIndex + 1);
            }
        }

        function previousImage() {
            if (currentImageIndex > 0) {
                showImage(currentImageIndex - 1);
            }
        }

        $(document).ready(function() {
            $('#showDeletablePpts').click(function() {
                $.getJSON('/admin/deletablePpts', function(data) {
                    var select = $('#deletablePptSelect');
                    select.empty();
                    if (data.length > 0) {
                        $.each(data, function(index, ppt) {
                            select.append($('<option>', { 
                                value: ppt.id,
                                text : ppt.filename 
                            }));
                        });
                        $('#deletablePptContainer').show();
                        $('#deletePptButton').show();
                    } else {
                        alert('No deletable PPTs found');
                        $('#deletablePptContainer').hide();
                        $('#deletePptButton').hide();
                    }
                });
            });

            $('#deletePptButton').click(function() {
                var selectedPptId = $('#deletablePptSelect').val();
                if (selectedPptId) {
                    $.ajax({
                        url: '/admin/deletePpt/' + selectedPptId,
                        type: 'POST',
                        data: {
                            _method: 'DELETE'
                        },
                        success: function(response) {
                            alert('PPT deleted successfully');
                            window.location.reload();
                        },
                        error: function(error) {
                            alert('Error deleting PPT');
                        }
                    });
                } else {
                    alert('Please select a PPT to delete.');
                }
            });
        });
        function togglePptDropdown() {
            $('#pptDropdown').toggleClass('d-none');
        }

        function changePpt() {
            var selectedPptId = $('#pptSelect').val();
            setPptSession(selectedPptId);
            togglePptDropdown();
        }

        $('#changePptButton').click(function() {
            togglePptDropdown();
        });
      
        $(document).ready(function() {
            $('#toggleChangeButton').click(function() {
                $('#changePptForm').toggleClass('d-none');
                $(this).toggleClass('d-none');
            });
        });

    </script>
</head>
<body>
     <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom">
        <a class="navbar-brand" th:href="@{/admin}">Kezdőlap</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/admin/data}">Adatok</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/admin/ppt}">Oktatás</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/admin/positions}">Pozíciók</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/admin/company}">Cégek</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/admin/receiver}">Fogadó felek</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/admin/dataupload}">Adat feltöltés</a>
                </li>
            </ul>
        </div>
    </nav>
   <div class="card mb-3">
        <div class="card-header">
            <h2>Current PPT</h2>
            <span class="small" th:text="${activePpts.size() > 0 ? 'Active PPTs: ' + activePpts.size() : 'No active PPTs'}"></span>
        </div>
        <div class="card-body">
            <button id="toggleChangeButton" class="btn btn-primary">Change</button>
            <form id="changePptForm" th:action="@{/admin/changeActivePpt}" method="post" class="form-inline d-none">
                <div class="form-group mr-2">
                    <select name="pptIds" class="form-control" multiple>
                        <option th:each="ppt : ${allPpts}" th:value="${ppt.id}"
                                th:selected="${ppt.isActive}" th:text="${ppt.filename}">
                        </option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Change</button>
            </form>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header">
            <h2>Add PPT</h2>
        </div>
        <div class="card-body">
            <form th:action="@{/admin/new}" method="get">
                <button type="submit" class="btn btn-success">Add New PPT</button>
            </form>
        </div>
    </div>
    
    <div class="card mb-3">
        <div class="card-header">
            <h2>All PPTs</h2>
        </div>
<div class="card-body">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="ppt : ${allPpts}">
                <td th:text="${ppt.id}"></td>
                <td th:text="${ppt.filename}"></td>
                <td>
                    <button type="button" class="btn btn-info btn-sm" 
                            th:onclick="'showPptImagesModal(' + ${ppt.id} + ')'">View</button>
                    <button type="button" class="btn btn-warning btn-sm" 
                            th:onclick="'setPptSession(' + ${ppt.id} + ')'">Questions</button>
                </td>
            </tr>
        </tbody>
    </table>
</div>


    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <div class="card mb-3">
        <div class="card-header">
            <h2>Delete PPT</h2>
        </div>
        <div class="card-body">
            <button id="showDeletablePpts" class="btn btn-danger mb-2">Show Deletable PPTs</button>
            <div id="deletablePptContainer" style="display: none;">
                <div class="form-group">
                    <select id="deletablePptSelect" class="form-control"></select>
                </div>
                <button id="deletePptButton" class="btn btn-danger" style="display: none;">Delete</button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="pptModal" tabindex="-1" aria-labelledby="pptModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pptModalLabel">PPT Images</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <button id="previousButton" class="btn btn-secondary" onclick="previousImage()">Previous</button>
                    <img id="pptImage" class="img-fluid mx-auto d-block" />
                    <button id="nextButton" class="btn btn-secondary" onclick="nextImage()">Next</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
